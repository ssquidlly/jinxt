jinxt/master
"use strict";(function(){var o=0;var m=32767;function b(){this.parent=null;this.x=0;this.y=0;this.f=0;this.g=0;this.h=0}var j=[];function c(){var p;if(j.length){p=j.pop()}else{p=new b()}p.parent=null;p.x=0;p.y=0;p.f=0;p.g=0;p.h=0;return p}function e(p){if(j.length<64000){j.push(p)}}function n(p,q){this.x=p||0;this.y=q||0}var a=[];function f(){if(a.length){return a.pop()}else{return new n(0,0)}}function k(p){if(a.length<10000){a.push(p)}}var g=false;var d=(typeof document==="undefined");var i=null;if(d){self.addEventListener("message",function(p){var q=p.data;if(!q){return}if(q.cmd==="init"){if(!i){i=new h()}i.init(q.hcells,q.vcells,q.data,q.diagonals)}else{if(q.cmd==="find"){i.pathEnd.parent=null;i.targetX=q.endX;i.targetY=q.endY;if(i.doLongFindPath(q.startX,q.startY)){self.postMessage({cmd:"result",pathList:i.pathList})}else{self.postMessage({cmd:"result",pathList:null})}}else{if(q.cmd==="region"){i.writeCells(q.offx,q.offy,q.lenx,q.leny,q.data)}else{if(q.cmd==="setdiag"){if(i){i.diagonalsEnabled=q.diagonals}}}}}},false)}function h(){this.hcells=0;this.vcells=0;this.pathEnd=c();this.cells=null;this.openList=[];this.closedList=[];this.closedCache={};this.pathList=[];this.currentNode=null;this.targetX=0;this.targetY=0;this.diagonalsEnabled=true;this.worker=null;this.workerQueue=[];this.workerRecycle=[];var q=this;var r,p;if(g&&!d){this.worker=new Worker("NOOP");this.worker.addEventListener("message",function(s){if(!s||!s.data){return}if(s.data.cmd==="result"){if(s.data.pathList){for(r=0,p=q.pathList.length;r<p;r++){k(q.pathList[r])}q.pathList=s.data.pathList;q.workerQueue[0].success()}else{q.workerQueue[0].fail()}q.workerRecycle.push(q.workerQueue.shift())}},false);this.worker.addEventListener("error",function(s){console.error(s)},false);this.worker.postMessage(null)}}h.prototype.init=function(q,p,s,r){this.hcells=q;this.vcells=p;this.cells=s;this.diagonalsEnabled=r;if(g&&!d){this.worker.postMessage({cmd:"init",hcells:q,vcells:p,diagonals:r,data:s})}};h.prototype.updateRegion=function(r,p,q,s,t){this.writeCells(r,p,q,s,t);if(g&&!d){this.worker.postMessage({cmd:"region",offx:r,offy:p,lenx:q,leny:s,data:t})}};h.prototype.writeCells=function(q,r,u,s,t){var p,v;for(p=0;p<u;++p){for(v=0;v<s;++v){this.cells[q+p][r+v]=t[p][v]}}};h.prototype.isReady=function(){return !!this.cells};h.prototype.setDiagonals=function(p){if(this.diagonalsEnabled===p){return}this.diagonalsEnabled=p;if(g&&!d){this.worker.postMessage({cmd:"setdiag",diagonals:p,})}};h.prototype.at=function(p,q){if(p<0||q<0||p>=this.hcells||q>=this.vcells){return m}return this.cells[p][q]};h.prototype.findPath=function(C,B,q,p,r,I){if(!this.cells){I();return}C=Math.floor(C);B=Math.floor(B);q=Math.floor(q);p=Math.floor(p);this.targetX=q;this.targetY=p;this.pathEnd.parent=null;var H=Math.min(C,q);var F=Math.max(C,q);var E=Math.min(B,p);var D=Math.max(B,p);if(H<0||E<0||F>=this.hcells||D>=this.vcells){I();return}var u,t,w,z,G,A,v;if(this.diagonalsEnabled){var s=true;for(u=H;u<=F;u++){for(t=E;t<=D;t++){if(this.cells[u][t]!==0){s=false;u=F+1;break}}}if(s){for(w=0,z=this.pathList.length;w<z;w++){k(this.pathList[w])}this.pathList.length=0;this.pathEnd.x=q;this.pathEnd.y=p;this.pathEnd.parent=null;v=f();v.x=q;v.y=p;this.pathList.push(v);r();return}}if(g){if(this.workerRecycle.length){A=this.workerRecycle.pop()}else{A={}}A.success=r;A.fail=I;this.workerQueue.push(A);this.worker.postMessage({cmd:"find",startX:C,startY:B,endX:q,endY:p})}else{if(this.doLongFindPath(C,B)){r()}else{I()}}};h.prototype.doLongFindPath=function(H,G){var E,F,I,C,B,q=8,t=-1,A;for(E=0,F=this.openList.length;E<F;E++){e(this.openList[E])}for(E=0,F=this.closedList.length;E<F;E++){e(this.closedList[E])}for(E=0,F=this.pathList.length;E<F;E++){k(this.pathList[E])}this.openList.length=0;this.closedList.length=0;this.closedCache={};this.pathList.length=0;var J=c();J.x=H;J.y=G;this.openList.push(J);var s=false,r=false,v=false,u=false;var D=this.diagonalsEnabled;while(this.openList.length){I=this.openList.shift();this.closedList.unshift(I);this.closedCache[((I.x<<16)+I.y).toString()]=true;if(I.x===this.targetX&&I.y===this.targetY){this.pathEnd.parent=I.parent;this.pathEnd.x=I.x;this.pathEnd.y=I.y;B=this.pathEnd;while(B){if(this.pathList.length===0){A=true;if(B.parent){q=this.nodeDirection(B,B.parent);t=q}}else{if(!B.parent){A=false}else{t=this.nodeDirection(B,B.parent);A=(t!==q)}}if(A){C=f();C.x=B.x;C.y=B.y;this.pathList.unshift(C);q=t}B=B.parent}return true}this.currentNode=I;var z=I.x;var w=I.y;var s=(this.at(z-1,w)===m);var r=(this.at(z,w-1)===m);var v=(this.at(z+1,w)===m);var u=(this.at(z,w+1)===m);if(!s){this.addCellToOpenList(z-1,w,10)}if(D&&!s&&!r){this.addCellToOpenList(z-1,w-1,14)}if(!r){this.addCellToOpenList(z,w-1,10)}if(D&&!r&&!v){this.addCellToOpenList(z+1,w-1,14)}if(!v){this.addCellToOpenList(z+1,w,10)}if(D&&!v&&!u){this.addCellToOpenList(z+1,w+1,14)}if(!u){this.addCellToOpenList(z,w+1,10)}if(D&&!u&&!s){this.addCellToOpenList(z-1,w+1,14)}}return false};h.prototype.insertToOpenList=function(r){var q,p;if(r.f>=this.openList[this.openList.length-1].f){this.openList.push(r)}else{for(q=0,p=this.openList.length;q<p;q++){if(r.f<this.openList[q].f){this.openList.splice(q,0,r);break}}}};h.prototype.addCellToOpenList=function(r,t,q){if(this.closedCache.hasOwnProperty(((r<<16)+t).toString())){return}var u,p,v;var s=this.at(r,t);for(u=0,p=this.openList.length;u<p;u++){v=this.openList[u];if(r===v.x&&t===v.y){if(this.currentNode.g+q+s<v.g){v.parent=this.currentNode;v.g=this.currentNode.g+q+s;v.h=this.estimateH(v.x,v.y);v.f=v.g+v.h;if(this.openList.length===1){return}this.openList.splice(u,1);this.insertToOpenList(v)}return}}v=c();v.x=r;v.y=t;v.h=this.estimateH(r,t);v.g=this.currentNode.g+q+s;v.f=v.h+v.g;v.parent=this.currentNode;if(!this.openList.length){this.openList.push(v);return}this.insertToOpenList(v)};function l(p){return p<0?-p:p}h.prototype.estimateH=function(q,s){var r=l(q-this.targetX);var p=l(s-this.targetY);return r*10+p*10};h.prototype.nodeDirection=function(q,p){var s=q.x;var r=q.y;var u=p.x;var t=p.y;if(s===u){if(t>r){return 6}if(t<r){return 2}if(r==t){return 8}}else{if(r===t){if(u>s){return 4}if(t<s){return 0}}else{if(u<s&&t<r){return 1}if(u>s&&t<r){return 3}if(u<s&&t>r){return 7}if(u>s&&t>r){return 5}}}return 8};if(!d){window.PF_CLEAR=o;window.PF_OBSTACLE=m;window.Pathfinder=h;window.ResultNode=n;window.allocResultNode=f;window.freeResultNode=k}})();
